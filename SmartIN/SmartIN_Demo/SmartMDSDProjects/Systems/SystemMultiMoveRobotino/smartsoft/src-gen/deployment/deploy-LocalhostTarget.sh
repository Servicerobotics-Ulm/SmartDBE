#!/bin/bash
#--------------------------------------------------------------------------
# Code generated by the SmartSoft MDSD Toolchain
# The SmartSoft Toolchain has been developed by:
#  
# Service Robotics Research Center
# University of Applied Sciences Ulm
# Prittwitzstr. 10
# 89075 Ulm (Germany)
#
# Information about the SmartSoft MDSD Toolchain is available at:
# www.servicerobotik-ulm.de
#
# Please do not modify this file. It will be re-generated
# running the code generator.
#--------------------------------------------------------------------------
#
# run this script from the component's root folder to deploy the scenario to device.
#

TARGET_SSHUSER=
TARGET_IP=127.0.0.1
TARGET_DIRECTORY="/tmp"
DEPLOYMENT_DIRECTORY=SystemMultiMoveRobotino.deployment/

echo "#######################################################"
echo "## Deployment of Device LocalhostTarget / $TARGET_IP"
echo "#######################################################"
echo "Target SSH user:      $TARGET_SSHUSER"
echo "Target IP:            $TARGET_IP"
echo "Target directory:     $TARGET_DIRECTORY"
echo "Deployment directory: $DEPLOYMENT_DIRECTORY"

echo "Working directory of deployment script: "`pwd`

echo Sourcing referenced projects
source src-gen/deployment/referenced-projects

DEPLOY_LIBRARIES_USER=""
###############################
echo "Sourcing pre-deployment script for RobotOperator... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-RobotOperator.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_SmartJoystickServer/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $REFERENCED_PROJECT_SmartJoystickServer/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_SmartJoystickServer"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer="$DEPLOY_COMPONENT_TCL_MODEL_FILES_SmartJoystickServer $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer "
#########################

echo
###############################
 
###############################
echo "Sourcing pre-deployment script for Robotino... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-Robotino.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_ComponentWebotsMobileRobot/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot="$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot $REFERENCED_PROJECT_ComponentWebotsMobileRobot/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot="$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_ComponentWebotsMobileRobot"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebotsMobileRobot="$DEPLOY_COMPONENT_TCL_MODEL_FILES_ComponentWebotsMobileRobot $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebotsMobileRobot "
#########################

echo
###############################
 
###############################
echo "Sourcing pre-deployment script for SJMan... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-SJMan.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_SmartJoystickManager/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager $REFERENCED_PROJECT_SmartJoystickManager/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_SmartJoystickManager"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickManager="$DEPLOY_COMPONENT_TCL_MODEL_FILES_SmartJoystickManager $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickManager "
#########################

echo
###############################
 
###############################
echo "Sourcing pre-deployment script for SJNav... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-SJNav.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_SmartJoystickNavigation/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation $REFERENCED_PROJECT_SmartJoystickNavigation/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_SmartJoystickNavigation"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickNavigation="$DEPLOY_COMPONENT_TCL_MODEL_FILES_SmartJoystickNavigation $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickNavigation "
#########################

echo
###############################
 
###############################
echo "Sourcing pre-deployment script for SafetyOfficer... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-SafetyOfficer.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_SmartJoystickServer/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $REFERENCED_PROJECT_SmartJoystickServer/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer="$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_SmartJoystickServer"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer="$DEPLOY_COMPONENT_TCL_MODEL_FILES_SmartJoystickServer $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer "
#########################

echo
###############################
 
###############################
echo "Sourcing pre-deployment script for WebotsLink... (errors might be ignored)"
DEPLOY_LIBRARIES=""
DEPLOY_COMPONENT_FILES=""
source src/predeploy-WebotsLink.sh 2>&1

for I in $DEPLOY_LIBRARIES; do
	if [ -e "$SMART_ROOT_ACE/bin/$I" ]; then
		FILE="$SMART_ROOT_ACE/bin/$I"
	else
		FILE="$SMART_ROOT_ACE/lib/$I"
	fi
	DEPLOY_LIBRARIES_USER="$DEPLOY_LIBRARIES_USER $FILE"
done

DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots=""
for I in $DEPLOY_COMPONENT_FILES; do
	if ls $REFERENCED_PROJECT_ComponentWebots/$I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots="$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots $REFERENCED_PROJECT_ComponentWebots/$I"
	elif ls $I > /dev/null 2>&1; then
		DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots="$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots $I"
	fi
done

#########################
## BEHAVIOR FILES
shopt -u | grep -q nullglob && changed=true && shopt -s nullglob
for entry in "$REFERENCED_PROJECT_ComponentWebots"/model/*.smartTcl
do
  DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebots="$DEPLOY_COMPONENT_TCL_MODEL_FILES_ComponentWebots $entry"
done
[ $changed ] && shopt -u nullglob; unset changed

echo "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebots "
#########################

echo
###############################
 

# the commented-out libraries are no longer copied from $SMART_ROOT_ACE
# instead they are installed from debian packages
#$SMART_ROOT_ACE/lib/libAceSmartSoftKernel.so.*
#$SMART_ROOT_ACE/lib/libSmartProperty.so.*
#$SMART_ROOT_ACE/bin/NamingService
DEPL_FILES="
src-gen/deployment/tiler.sh
src-gen/deployment/start-LocalhostTarget.sh
src-gen/deployment/ns_config.ini
$DEPLOY_LIBRARIES_USER
"

if [ "$1" = "tempfolder" ]; then
	echo "The copying of the component-binaris, ini-files and comm-obj libraries is deactivated from the Teamserver's deployment script"
else
DEPL_FILES="$DEPL_FILES
src/RobotOperator_data
src/startstop-hooks-RobotOperator.sh
$SMART_ROOT_ACE/lib/libCommBasicObjects*
src/Robotino_data
src/startstop-hooks-Robotino.sh
$SMART_ROOT_ACE/lib/libCommBasicObjects*
$SMART_ROOT_ACE/lib/libCommLocalizationObjects*
src/SJMan_data
src/startstop-hooks-SJMan.sh
$SMART_ROOT_ACE/lib/libCommBasicObjects*
src/SJNav_data
src/startstop-hooks-SJNav.sh
$SMART_ROOT_ACE/lib/libCommBasicObjects*
src/SafetyOfficer_data
src/startstop-hooks-SafetyOfficer.sh
$SMART_ROOT_ACE/lib/libCommBasicObjects*
src/WebotsLink_data
src/startstop-hooks-WebotsLink.sh
$SMART_ROOT_ACE/bin/SmartJoystickServer
src-gen/combined-ini-files/RobotOperator.ini
$SMART_ROOT_ACE/bin/ComponentWebotsMobileRobot
src-gen/combined-ini-files/Robotino.ini
$SMART_ROOT_ACE/bin/SmartJoystickManager
src-gen/combined-ini-files/SJMan.ini
$SMART_ROOT_ACE/bin/SmartJoystickNavigation
src-gen/combined-ini-files/SJNav.ini
$SMART_ROOT_ACE/bin/SmartJoystickServer
src-gen/combined-ini-files/SafetyOfficer.ini
$SMART_ROOT_ACE/bin/ComponentWebots
src-gen/combined-ini-files/WebotsLink.ini
"
fi

FILES_MISSING=false
for FILE in $DEPL_FILES; do
	if [ ! -e $FILE ]; then
		echo "Deployment: No such file or directory: $FILE"
		FILES_MISSING=true
	fi
done

if [ "$FILES_MISSING" = "true" ]; then
	echo
	echo "ERROR: FILES ARE MISSING FROM THE DEPLOYMENT (see above). Did you compile all components?"
	echo 
	exit 1
fi


if [ "$1" = "tempfolder" ]; then
	#rsync -l -r -v --progress --exclude ".svn" $DEPL_FILES /tmp/$DEPLOYMENT_DIRECTORY
	SSH_TARGET=/tmp/$DEPLOYMENT_DIRECTORY
else
	# remote deployment
	SSH_TARGET=127.0.0.1:$TARGET_DIRECTORY/$DEPLOYMENT_DIRECTORY
	echo "Deployment to $SSH_TARGET"
	ssh 127.0.0.1 mkdir -p $TARGET_DIRECTORY/$DEPLOYMENT_DIRECTORY
fi

TMPDIR=$(mktemp -d --suffix=.deployment) || exit 1
echo "Temporary directory: $TMPDIR"
mkdir $TMPDIR/behaviorFiles
trap "rm -rf $TMPDIR" EXIT

# collect files in $TMPDIR
#rsync -l -r -v --progress --exclude ".svn" $DEPL_FILES $TMPDIR/
cp -rv $DEPL_FILES $TMPDIR 2>&1
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $TMPDIR/RobotOperator_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $TMPDIR/RobotOperator_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_SmartJoystickServer/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-SmartJoystickServer.sh 2>/dev/null
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot $TMPDIR/Robotino_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_ComponentWebotsMobileRobot $TMPDIR/Robotino_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebotsMobileRobot" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebotsMobileRobot $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_ComponentWebotsMobileRobot/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-ComponentWebotsMobileRobot.sh 2>/dev/null
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager $TMPDIR/SJMan_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickManager $TMPDIR/SJMan_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickManager" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickManager $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_SmartJoystickManager/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-SmartJoystickManager.sh 2>/dev/null
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation $TMPDIR/SJNav_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickNavigation $TMPDIR/SJNav_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickNavigation" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickNavigation $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_SmartJoystickNavigation/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-SmartJoystickNavigation.sh 2>/dev/null
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $TMPDIR/SafetyOfficer_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_SmartJoystickServer $TMPDIR/SafetyOfficer_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_SmartJoystickServer $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_SmartJoystickServer/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-SmartJoystickServer.sh 2>/dev/null
#rsync -l -r -v --progress --exclude ".svn" $DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots $TMPDIR/WebotsLink_data/
if [ ! "$DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_FILES_PATHS_ComponentWebots $TMPDIR/WebotsLink_data/ 2>&1
fi

if [ ! "$DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebots" = "" ]; then
	cp -rv $DEPLOY_COMPONENT_BEHAVIOR_MODEL_FILES_ComponentWebots $TMPDIR/behaviorFiles/ 2>&1
fi

cp -v $REFERENCED_PROJECT_ComponentWebots/smartsoft/src/startstop-hooks.sh $TMPDIR/startstop-hooks-component-ComponentWebots.sh 2>/dev/null

#collect and copy behavior related files
echo "Sourcing behavior files..."
test -f src-gen/deployment/deploy-behavior-files.sh && source src-gen/deployment/deploy-behavior-files.sh

# actually deploy:
rsync -z -l -r -v --progress --exclude ".svn" -e ssh $TMPDIR/ $SSH_TARGET


if [ "$?" != "0" ]; then
	echo "ERROR: Files could not be deployed to remote host."
	#gdialog --title ERROR --msgbox "Files could not be deployed host."
	exit 1
fi

echo -e "\n\nDeployment to device LocalhostTarget finished.\n\n"
